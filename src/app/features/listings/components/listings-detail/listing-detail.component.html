<ng-template #isPremium>
  <div class="premium-tag">Premium</div>
</ng-template>

<ng-container *ngIf="this.listing$ | async as listing">
  <main class="detail-container">
    <!-- Partie haute avec galerie et colonne d'infos -->
    <div class="detail-culumn">
      <div>
        <div class="main-image-container">
          <img [src]="listing.images?.[0]?.url" [alt]="listing.title" id="main-image" class="main-image">
          <ng-container *ngIf="listing.is_premium">
            <ng-container *ngTemplateOutlet="isPremium"></ng-container>
          </ng-container>
        </div>
        <div class="thumbnail-container">
          <img *ngFor="let image of listing.images" [src]="image.url" [alt]="listing.title" class="thumbnail">
        </div>
        <div class="detail-content">
          <div class="detail-main wide">
            <div class="detail-section">
              <h2 class="section-title">Description</h2>
              <div class="description">
                <p>{{listing.description}}</p>
              </div>
            </div>
            
            <!-- Nouvelle section calendrier -->
            <div class="detail-section availability-section">
              <h2 class="section-title">Availability</h2>
              <div class="availability-container">
                <div class="calendar-wrapper">
                  <div id="reservation-calendar"></div>
                </div>
              </div>
            </div>
            <!-- Fin section calendrier -->
          </div>
        </div>
      </div>
      
      <div class="info-booking-column">
        <!-- Item essentials -->
        <div class="item-essentials">
          <h1 class="item-title">{{listing.title}}</h1>
          <div class="partner-info" *ngIf="listing.partner">
            <img [src]="listing.partner.avatar_url || 'assets/images/default-avatar.jpeg'" alt="Partner" class="partner-avatar">
            <div class="partner-details">
              <div class="partner-name">{{listing.partner.firstname}} {{listing.partner.lastname}}</div>
              <div class="partner-rating" *ngIf="listing.partner.partner_rating">
                <i class="fas fa-star star" *ngFor="let star of getStarArray(listing.partner.partner_rating)"></i>
                <i class="fas fa-star-half-alt star" *ngIf="listing.partner.partner_rating % 1 !== 0"></i>
                <span class="rating-value">{{listing.partner.partner_rating}}</span>
                <span class="rating-count">({{listing.partner.partner_reviews || 0}} reviews)</span>
              </div>
            </div>
          </div>

          <!-- Nouvelle section pour la catégorie et la livraison -->
          <div class="item-details">
            <div class="detail-item" *ngIf="listing.category">
              <i class="fas fa-tag"></i>
              <span>{{listing.category.name}}</span>
            </div>
            <div class="detail-item" *ngIf="listing.delivery_option">
              <i class="fas fa-truck"></i>
              <span>Delivery available</span>
            </div>
          </div>
          <!-- Fin nouvelle section -->

          <div class="item-location" *ngIf="listing.city">
            <i class="fas fa-map-marker-alt"></i>
            <span>{{listing.city.name}}</span>
          </div>
          <!-- Section de la carte déplacée ici -->
          <div class="detail-section location-map-section">
            <div id="map"></div>
          </div>
          <!-- Fin carte -->
        </div>
        <!-- Fin item-essentials -->
         
        <!-- Booking card -->
        <div class="booking-card">
          <h3 class="booking-title">Book This Item</h3>
          <div class="item-price">${{listing.price_per_day}} <span class="price-period">/ day</span></div>
          <div class="booking-form">
            <div class="price-breakdown">
              <div class="breakdown-item">
                <span class="item-label">Selected dates:</span>
                <span id="selected-dates" class="item-value">Select dates</span>
              </div>
              <div class="breakdown-item">
                <span class="item-label">Rental cost</span>
                <span id="listing-cost" class="item-value">-</span>
              </div>
              <div class="breakdown-item total">
                <span class="item-label">Total</span>
                <span id="total-price" class="item-value">-</span>
              </div>
            </div>
            <button class="reserve-button" (click)="rent(listing.id)">
              <i class="fas fa-calendar-check"></i>
              Reserve Now
            </button>
            <div class="booking-note">
              <i class="fas fa-info-circle"></i>
              You won't be charged yet. Payment is due at pickup.
            </div>
          </div>
        </div>        
      </div>
    </div>
  </main>
</ng-container>