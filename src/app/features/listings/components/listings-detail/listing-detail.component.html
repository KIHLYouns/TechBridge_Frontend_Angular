<ng-template #isPremium>
  <div class="premium-tag">Premium</div>
</ng-template>

<div class="detail-container" *ngIf="listing$ | async as listing; else loading">
  <div class="detail-culumn">
    <div>
      <!-- Galerie d'images -->
      <div class="main-image-container">
        <img [src]="selectedImageUrl || listing.images?.[0]?.url || 'assets/images/item-placeholder.jpg'" 
             [alt]="listing.title" 
             id="main-image" 
             class="main-image">
        <div *ngIf="listing.is_premium" class="premium-tag">Premium</div>
      </div>
      <div class="thumbnail-container" *ngIf="listing.images && listing.images.length > 1">
        <img *ngFor="let image of listing.images" 
             [src]="image.url" 
             alt="Thumbnail" 
             class="thumbnail"
             [class.active]="image.url === (selectedImageUrl || listing.images[0].url)"
             (click)="selectImage(image.url)">
      </div>
      <!-- Contenu principal -->
      <div class="detail-content">
        <div class="detail-main wide">
          <div class="detail-section">
            <h2 class="section-title">Description</h2>
            <div class="description">
              <p>{{ listing.description }}</p>
            </div>
          </div>
          <div class="detail-section availability-section">
            <h2 class="section-title">Availability</h2>
            <div class="availability-container">
              <div class="calendar-wrapper">
                <div id="reservation-calendar" #reservationCalendar></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Colonne droite avec infos et réservation -->
    <div class="info-booking-column">
      <div class="item-essentials">
         <h1 class="item-title">{{ listing.title }}</h1>
         <!-- Informations partenaire -->
         <div class="partner-info" *ngIf="listing.partner">
           <img [src]="listing.partner.avatar_url || 'assets/images/default-avatar.jpeg'" alt="Partner Avatar" class="partner-avatar">
           <div class="partner-details">
             <div class="partner-name">{{ listing.partner.firstname + ' ' + listing.partner.lastname || 'Partner Name' }}</div>
             <div class="partner-rating" *ngIf="listing.partner.partner_rating !== undefined && listing.partner.partner_rating !== null">
               <ng-container *ngFor="let i of getStarArray(listing.partner.partner_rating)">
                 <i class="fas fa-star star"></i>
               </ng-container>
               <span class="rating-value">{{ listing.partner.partner_rating | number:'1.1-1' }}</span>
               <span class="rating-count">({{ listing.partner.partner_reviews || 0 }} reviews)</span>
             </div>
             <div class="partner-rating" *ngIf="listing.partner.partner_rating === undefined || listing.partner.partner_rating === null">
               <span class="rating-count">No reviews yet</span>
             </div>
           </div>
         </div>
         <!-- Détails -->
         <div class="item-details">
           <div class="detail-item" *ngIf="listing.category">
             <i class="fas fa-tag"></i>
             <span>{{ listing.category.name }}</span>
           </div>
           <div class="detail-item" *ngIf="listing.delivery_option">
             <i class="fas fa-truck"></i>
             <span>Delivery available</span>
           </div>
           <div class="detail-item" *ngIf="!listing.delivery_option">
             <i class="fas fa-door-open"></i>
             <span>Pickup only</span>
           </div>
         </div>
         <div class="item-location" *ngIf="listing.city">
           <i class="fas fa-map-marker-alt"></i>
           <span>{{ listing.city.name }}</span>
         </div>
         <!-- Carte de localisation -->
         <div class="detail-section location-map-section" *ngIf="listing.partner?.latitude && listing.partner?.longitude">
          <div id="map" #map></div>
         </div>
      </div>
      <!-- Carte de réservation -->
      <div class="booking-card">
        <h3 class="booking-title">Book This Item</h3>
        <div class="item-price">
          {{ listing.price_per_day | currency:'USD':'symbol':'1.0-0' }} <span class="price-period">/ day</span>
        </div>
        <div class="booking-form">
          <div class="price-breakdown">
            <div class="breakdown-item">
              <span class="item-label">Selected dates:</span>
              <span id="selected-dates" class="item-value">
                <ng-container *ngIf="selectedStartDate && selectedEndDate; else selectDatesText">
                  {{ selectedStartDate }} to {{ selectedEndDate }} ({{ numberOfDays }} days)
                </ng-container>
                <ng-template #selectDatesText>Select dates</ng-template>
              </span>
            </div>
            <div class="breakdown-item">
              <span class="item-label">Rental cost</span>
              <span id="rental-cost" class="item-value">
                {{ rentalCost !== null ? (rentalCost | currency:'USD':'symbol':'1.0-0') : '-' }}
              </span>
            </div>
            <div class="breakdown-item total">
              <span class="item-label">Total</span>
              <span id="total-price" class="item-value">
                {{ totalPrice !== null ? (totalPrice | currency:'USD':'symbol':'1.0-0') : '-' }}
              </span>
            </div>
          </div>
          <button class="reserve-button" [disabled]="!selectedStartDate || !selectedEndDate">
            <i class="fas fa-calendar-check"></i>
            Reserve Now
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<ng-template #loading>
  <div class="loading-indicator">
    Loading listing details...
  </div>
</ng-template>